on:
    workflow_call:
  
jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Install systemd lib dependencies
      run: |
        sudo apt update
        sudo apt install -o Acquire::Retries=10 libsystemd-dev

    - name: Build
      run: go build -v ./...

    - name: Allow non-interactive tests to use systemd D-Bus API polkit >=106
      uses: "DamianReeves/write-file-action@master"
      with:
        path: /usr/share/polkit-1/rules.d/99-mirasol-ci.rules
        write-mode: overwrite
        contents: |
          // Allow any user to manage units.
          // Fall back to implicit authorization otherwise.
          polkit.addRule(function(action, subject) {
              if (action.id == "org.freedesktop.systemd1.manage-units") ||
              (action.id == "org.freedesktop.systemd1.manage-unit-files") {
                  return polkit.Result.YES;
              }
          });

    - name: Allow non-interactive tests to use systemd D-Bus API polkit <106
      run: |
        gid=`id -gn`
        cat << EOF | sudo tee /etc/polkit-1/localauthority/50-local.d/mirasol-ci.pkla
        [CI Permissions]
        Identity=unix-group:$gid
        Action=org.freedesktop.systemd1.*
        ResultAny=yes
        ResultInactive=yes
        ResultActive=yes
        EOF

    # End-to-end tests must run sequentially so they don't compete for
    # fixtures, such as when (un)installing systemd unit files.
    - name: E2E tests
      run: go test -run Test_E2E_ -shuffle=on -v ./...
